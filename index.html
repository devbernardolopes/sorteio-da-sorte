<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg max-w-sm w-full text-center">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Finalizar Pagamento</h2>
      <p class="text-gray-600 mb-6">
        Escaneie o QR Code abaixo para pagar via PIX.
      </p>

      <div id="qrcode" class="flex justify-center mb-6"></div>

      <div class="bg-gray-50 p-3 rounded border border-dashed border-gray-300">
        <p class="text-xs text-gray-500 uppercase font-bold mb-1">
          Copia e Cola
        </p>
        <code id="pix-string" class="text-xs break-all text-blue-600"
          >00020126580014br.gov.bcb.pix...</code
        >
      </div>

      <button
        onclick="copyPix()"
        class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition"
      >
        Copiar Código PIX
      </button>
    </div>

    <script>
      // Function to get the PIX code from your local server
      async function loadPix() {
        try {
          // This tells the browser: "Look for the /api/generate-pix folder on the SAME domain I'm on"
          const response = await fetch("/api/generate-pix");
          const data = await response.json();

          const pixPayload = data.copyAndPaste;

          // Display the string in the UI
          document.getElementById("pix-string").innerText = pixPayload;

          // Generate the QR Code
          // Clear previous QR code if any
          document.getElementById("qrcode").innerHTML = "";
          new QRCode(document.getElementById("qrcode"), {
            text: pixPayload,
            width: 200,
            height: 200,
          });

          // Store it globally so the copy button works
          window.currentPixPayload = pixPayload;
        } catch (error) {
          console.error("Could not fetch PIX:", error);
          document.getElementById("pix-string").innerText = "Error loading PIX";
        }
      }

      // Update your copy function to use the fetched string
      function copyPix() {
        if (window.currentPixPayload) {
          navigator.clipboard.writeText(window.currentPixPayload);
          alert("Código copiado!");
        }
      }

      // Load it when the page opens
      loadPix();
    </script>
  </body>
</html>
